Code is based on Fehr and Kindermann 
